// main.js (Frontend) - Fixed Version with Enhanced Effects
const API_BASE_URL = 'https://shop-4mlk.onrender.com/api/v1';

// Global variables
let currentUser = null;
let userBalance = 0;

// Utility Functions
class Utils {
    static formatPrice(price) {
        const num = typeof price === 'string' ? parseInt(price) : price;
        if (isNaN(num)) return '0';
        return new Intl.NumberFormat('vi-VN').format(num);
    }
    
    static formatDate(date) {
        try {
            return new Date(date).toLocaleDateString('vi-VN');
        } catch (error) {
            return 'N/A';
        }
    }
    
    static formatDateTime(date) {
        try {
            return new Date(date).toLocaleString('vi-VN');
        } catch (error) {
            return 'N/A';
        }
    }
    
    static showToast(message, type = 'success', duration = 3000) {
        // Remove existing toasts
        document.querySelectorAll('.toast').forEach(toast => toast.remove());
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas ${this.getToastIcon(type)}"></i>
                <span class="toast-message">${message}</span>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        // Add toast styles if not exist
        this.addToastStyles();
        
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }
        }, duration);
    }
    
    static getToastIcon(type) {
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        return icons[type] || icons.info;
    }
    
    static addToastStyles() {
        if (document.getElementById('toast-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'toast-styles';
        style.textContent = `
            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                min-width: 300px;
                max-width: 500px;
                padding: 16px 20px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 40px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 15px;
                transform: translateX(120%);
                opacity: 0;
                transition: all 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
                z-index: 10000;
                border-left: 4px solid;
                backdrop-filter: blur(10px);
            }
            
            .toast.show {
                transform: translateX(0);
                opacity: 1;
            }
            
            .toast.success {
                border-left-color: #2a9d8f;
                background: linear-gradient(135deg, #2a9d8f, #20b2aa);
                color: white;
                box-shadow: 0 20px 40px rgba(42, 157, 143, 0.3);
            }
            
            .toast.error {
                border-left-color: #dc3545;
                background: linear-gradient(135deg, #dc3545, #ff6b6b);
                color: white;
                box-shadow: 0 20px 40px rgba(220, 53, 69, 0.3);
            }
            
            .toast.warning {
                border-left-color: #f4a261;
                background: linear-gradient(135deg, #f4a261, #ffd43b);
                color: #333;
                box-shadow: 0 20px 40px rgba(244, 162, 97, 0.3);
            }
            
            .toast.info {
                border-left-color: #1d3557;
                background: linear-gradient(135deg, #1d3557, #495057);
                color: white;
                box-shadow: 0 20px 40px rgba(29, 53, 87, 0.3);
            }
            
            .toast-content {
                display: flex;
                align-items: center;
                gap: 12px;
                flex: 1;
            }
            
            .toast-content i {
                font-size: 18px;
                animation: bounceIn 0.6s ease;
            }
            
            .toast-message {
                font-weight: 500;
                font-size: 14px;
            }
            
            .toast-close {
                background: none;
                border: none;
                color: inherit;
                cursor: pointer;
                padding: 6px;
                border-radius: 50%;
                transition: all 0.3s ease;
                opacity: 0.7;
                width: 28px;
                height: 28px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .toast-close:hover {
                opacity: 1;
                background: rgba(255,255,255,0.2);
                transform: scale(1.1);
            }
            
            @keyframes bounceIn {
                0% { transform: scale(0.3); opacity: 0; }
                50% { transform: scale(1.05); }
                70% { transform: scale(0.9); }
                100% { transform: scale(1); opacity: 1; }
            }
            
            @media (max-width: 768px) {
                .toast {
                    right: 10px;
                    left: 10px;
                    min-width: auto;
                    max-width: none;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    static validateInput(input, message, pattern) {
        const value = input.value.trim();
        if (!value) {
            this.showError(input, `Vui lòng nhập ${this.getFieldName(input)}.`);
            return false;
        }
        if (pattern && !pattern.test(value)) {
            this.showError(input, message);
            return false;
        }
        this.clearError(input);
        return true;
    }
    
    static getFieldName(input) {
        const label = input.previousElementSibling;
        if (label && label.tagName === 'LABEL') {
            return label.textContent.toLowerCase().replace('*', '').trim();
        }
        return input.placeholder || 'thông tin';
    }
    
    static showError(input, message) {
        const formGroup = input.closest('.form-group');
        if (formGroup) {
            formGroup.classList.add('has-error');
            const errorElement = formGroup.querySelector('.error-message');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        input.focus();
    }
    
    static clearError(input) {
        const formGroup = input.closest('.form-group');
        if (formGroup) {
            formGroup.classList.remove('has-error');
            const errorElement = formGroup.querySelector('.error-message');
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }
    }
    
    static showLoading(text = 'Đang xử lý...') {
        let loadingEl = document.getElementById('global-loading');
        if (!loadingEl) {
            loadingEl = document.createElement('div');
            loadingEl.id = 'global-loading';
            loadingEl.innerHTML = `
                <div class="loading-backdrop">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">${text}</div>
                    </div>
                </div>
            `;
            
            // Add loading styles
            const style = document.createElement('style');
            style.textContent = `
                #global-loading {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    z-index: 9999;
                    opacity: 0;
                    visibility: hidden;
                    transition: all 0.4s ease;
                }
                
                #global-loading.show {
                    opacity: 1;
                    visibility: visible;
                }
                
                .loading-backdrop {
                    width: 100%;
                    height: 100%;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(8px);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .loading-content {
                    text-align: center;
                    padding: 40px;
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                    border: 1px solid rgba(230, 57, 70, 0.1);
                    animation: fadeInUp 0.5s ease;
                }
                
                .loading-spinner {
                    width: 50px;
                    height: 50px;
                    border: 4px solid rgba(230, 57, 70, 0.2);
                    border-top: 4px solid #e63946;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                
                .loading-text {
                    color: #1d3557;
                    font-weight: 500;
                    font-size: 16px;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                @keyframes fadeInUp {
                    0% { transform: translateY(30px); opacity: 0; }
                    100% { transform: translateY(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(loadingEl);
        }
        
        loadingEl.querySelector('.loading-text').textContent = text;
        setTimeout(() => loadingEl.classList.add('show'), 10);
    }
    
    static hideLoading() {
        const loadingEl = document.getElementById('global-loading');
        if (loadingEl) {
            loadingEl.classList.remove('show');
        }
    }
    
    static debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    static throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    }
}

// API Functions with enhanced error handling
async function callApi(endpoint, method = 'GET', body = null, requiresAuth = true) {
    const headers = {
        'Content-Type': 'application/json',
    };
    
    if (requiresAuth) {
        const token = localStorage.getItem('token');
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
    }
    
    const options = {
        method,
        headers,
        credentials: 'include'
    };
    
    if (body) {
        options.body = JSON.stringify(body);
    }
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout
        
        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            ...options,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data;
        
    } catch (error) {
        console.error('API call failed:', {
            endpoint,
            method,
            error: error.message,
            stack: error.stack
        });
        
        if (error.name === 'AbortError') {
            throw new Error('Yêu cầu quá lâu, vui lòng thử lại');
        }
        
        if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
            throw new Error('Lỗi kết nối mạng, vui lòng kiểm tra internet');
        }
        
        throw error;
    }
}

// Authentication functions with better error handling and UI updates
async function authenticate(email, password) {
    try {
        Utils.showLoading('Đang đăng nhập...');
        const data = await callApi('/users/login', 'POST', { email, password }, false);
        
        if (data.token) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('currentUser', JSON.stringify(data.data.user));
            
            // Set current user
            currentUser = data.data.user;
            
            return data.data.user;
        }
        
        throw new Error('Không nhận được token đăng nhập');
        
    } catch (error) {
        console.error('Login failed:', error);
        throw new Error(error.message || 'Đăng nhập thất bại');
    } finally {
        Utils.hideLoading();
    }
}

async function registerUser(name, email, password, passwordConfirm) {
    try {
        Utils.showLoading('Đang tạo tài khoản...');
        const data = await callApi('/users/signup', 'POST', { 
            name, 
            email, 
            password, 
            passwordConfirm 
        }, false);
        
        if (data.token) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('currentUser', JSON.stringify(data.data.user));
            
            // Set current user
            currentUser = data.data.user;
            
            return data.data.user;
        }
        
        throw new Error('Không nhận được token đăng ký');
        
    } catch (error) {
        console.error('Registration failed:', error);
        throw new Error(error.message || 'Đăng ký thất bại');
    } finally {
        Utils.hideLoading();
    }
}

async function logoutUser() {
    try {
        Utils.showLoading('Đang đăng xuất...');
        
        // Try to call logout API
        try {
            await callApi('/users/logout', 'POST');
        } catch (error) {
            console.warn('Logout API failed, proceeding with local logout:', error);
        }
        
        // Clear local storage
        localStorage.removeItem('token');
        localStorage.removeItem('currentUser');
        localStorage.removeItem('userBalance');
        localStorage.removeItem('rememberMe');
        
        // Reset global variables
        currentUser = null;
        userBalance = 0;
        
        // Update UI
        updateUIAfterLogout();
        
        Utils.showToast('Đăng xuất thành công!', 'success');
        
        // Redirect if on account page
        if (window.location.pathname.includes('account.html')) {
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }
        
    } catch (error) {
        console.error('Logout failed:', error);
        Utils.showToast('Đăng xuất thất bại', 'error');
    } finally {
        Utils.hideLoading();
    }
}

// UI Update functions - FIXED
async function updateUIAfterLogin() {
    try {
        // Update current user and balance
        if (!currentUser) {
            const userData = await callApi('/users/me');
            currentUser = userData.data.user;
        }
        
        userBalance = await getUserBalance();
        
        // Save user data
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('userBalance', userBalance.toString());
        
        // Update header UI - THIS IS THE KEY FIX
        updateHeaderUserDisplay();
        
        // Update cart and favorites
        await updateCartCount();
        
        // Dispatch custom event
        window.dispatchEvent(new CustomEvent('userLoggedIn', { 
            detail: { user: currentUser, balance: userBalance } 
        }));
        
        console.log('UI updated after login for user:', currentUser.name);
        
    } catch (error) {
        console.error('Failed to update UI after login:', error);
        Utils.showToast('Không thể cập nhật thông tin người dùng', 'error');
    }
}

function updateUIAfterLogout() {
    // Update header UI
    const userDropdown = document.getElementById('userDropdown');
    const loginButton = document.getElementById('loginButton');
    
    if (userDropdown) {
        userDropdown.style.display = 'none';
    }
    
    if (loginButton) {
        loginButton.style.display = 'block';
    }
    
    // Reset cart and favorite buttons
    document.querySelectorAll('.cart-count, .cart-badge').forEach(el => {
        el.style.display = 'none';
        el.textContent = '0';
    });
    
    // Dispatch custom event
    window.dispatchEvent(new CustomEvent('userLoggedOut'));
}

function updateHeaderUserDisplay() {
    if (!currentUser) {
        console.warn('No current user to display');
        return;
    }
    
    const userDropdown = document.getElementById('userDropdown');
    const loginButton = document.getElementById('loginButton');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    
    if (!userDropdown || !loginButton) {
        console.warn('User dropdown or login button not found');
        return;
    }
    
    // Hide login button and show user dropdown
    loginButton.style.display = 'none';
    userDropdown.style.display = 'flex';
    
    // Update user info
    const firstLetter = currentUser.name.charAt(0).toUpperCase();
    
    if (userAvatar) {
        userAvatar.textContent = firstLetter;
        userAvatar.style.background = `linear-gradient(135deg, #e63946, #f77f00)`;
    }
    
    if (userName) {
        userName.textContent = currentUser.name;
    }
    
    // Initialize dropdown functionality if not already done
    initUserDropdown();
    
    console.log('Header UI updated for user:', currentUser.name);
}

function initUserDropdown() {
    const userDropdown = document.getElementById('userDropdown');
    const dropdownMenu = userDropdown?.querySelector('.dropdown-menu');
    const logoutButton = document.getElementById('logoutButton');
    
    if (!userDropdown || !dropdownMenu) {
        console.warn('User dropdown elements not found');
        return;
    }
    
    // Remove existing event listeners
    const newUserDropdown = userDropdown.cloneNode(true);
    userDropdown.parentNode.replaceChild(newUserDropdown, userDropdown);
    
    const newDropdownMenu = newUserDropdown.querySelector('.dropdown-menu');
    const newLogoutButton = newUserDropdown.querySelector('#logoutButton');
    
    // Toggle dropdown on click
    newUserDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = newUserDropdown.classList.contains('active');
        
        // Close all other dropdowns
        document.querySelectorAll('.user-dropdown.active').forEach(dropdown => {
            dropdown.classList.remove('active');
        });
        
        if (!isActive) {
            newUserDropdown.classList.add('active');
        }
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!newUserDropdown.contains(e.target)) {
            newUserDropdown.classList.remove('active');
        }
    });
    
    // Prevent dropdown from closing when clicking inside
    newDropdownMenu.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    // Logout button
    if (newLogoutButton) {
        newLogoutButton.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            await logoutUser();
        });
    }
}

// User functions
async function getUserBalance() {
    try {
        const data = await callApi('/users/me/balance');
        const balance = data.data.balance || 0;
        userBalance = balance;
        localStorage.setItem('userBalance', balance.toString());
        return balance;
    } catch (error) {
        console.error('Failed to get user balance:', error);
        return parseInt(localStorage.getItem('userBalance')) || 0;
    }
}

// Cart functions
async function updateCartCount() {
    try {
        const cart = await getCart();
        const cartCount = cart.reduce((total, item) => total + (item.quantity || 0), 0);
        
        const cartCountElements = document.querySelectorAll('.cart-count, .cart-badge');
        cartCountElements.forEach(el => {
            el.textContent = cartCount;
            el.style.display = cartCount > 0 ? 'inline-block' : 'none';
        });
        
        return cartCount;
        
    } catch (error) {
        console.error('Failed to update cart count:', error);
        return 0;
    }
}

async function getCart() {
    try {
        const data = await callApi('/cart');
        return data.data.cart || [];
    } catch (error) {
        console.error('Failed to get cart:', error);
        return [];
    }
}

// Auto-login check - ENHANCED
async function checkAutoLogin() {
    const token = localStorage.getItem('token');
    const storedUser = localStorage.getItem('currentUser');
    
    if (token && storedUser) {
        try {
            Utils.showLoading('Đang tải thông tin người dùng...');
            
            // Parse stored user
            currentUser = JSON.parse(storedUser);
            
            // Verify token is still valid by making a test API call
            await callApi('/users/me');
            
            // Update UI
            await updateUIAfterLogin();
            
            console.log('Auto-login successful for user:', currentUser.name);
            
        } catch (error) {
            console.error('Auto-login failed:', error);
            // Clear invalid data
            localStorage.removeItem('token');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userBalance');
            currentUser = null;
            userBalance = 0;
        } finally {
            Utils.hideLoading();
        }
    }
}

// Initialize page-specific functionality
function initPageSpecificFeatures() {
    const path = window.location.pathname;
    
    if (path.includes('index.html') || path === '/') {
        // Home page - load sample products
        loadSampleProducts();
    }
}

// Load sample products for demo
function loadSampleProducts() {
    const productsGrid = document.getElementById('productsGrid');
    if (!productsGrid) return;
    
    // Sample products data
    const sampleProducts = [
        {
            id: 'P001',
            name: 'Hạt giống cà chua bi',
            price: '25000',
            image: 'https://via.placeholder.com/300x200/4CAF50/white?text=Hạt+giống+cà+chua',
            description: 'Hạt giống cà chua bi chất lượng cao, năng suất tốt'
        },
        {
            id: 'P002',
            name: 'Chó Poodle mini',
            price: '2500000',
            image: 'https://via.placeholder.com/300x200/FF9800/white?text=Chó+Poodle',
            description: 'Chó Poodle mini thuần chủng, tiêm phòng đầy đủ'
        },
        {
            id: 'P003',
            name: 'Tài khoản LOL rank Kim Cương',
            price: '850000',
            image: 'https://via.placeholder.com/300x200/9C27B0/white?text=LOL+Account',
            description: 'Tài khoản LOL rank Kim Cương, nhiều skin đẹp'
        },
        {
            id: 'P004',
            name: 'Hạt giống rau muống',
            price: '15000',
            image: 'https://via.placeholder.com/300x200/4CAF50/white?text=Hạt+rau+muống',
            description: 'Hạt giống rau muống xanh, dễ trồng, phát triển nhanh'
        },
        {
            id: 'P005',
            name: 'Mèo Ba Tư',
            price: '1800000',
            image: 'https://via.placeholder.com/300x200/FF5722/white?text=Mèo+Ba+Tư',
            description: 'Mèo Ba Tư lông dài, thuần chủng, đã tiêm phòng'
        },
        {
            id: 'P006',
            name: 'Tài khoản PUBG Conqueror',
            price: '1200000',
            image: 'https://via.placeholder.com/300x200/795548/white?text=PUBG+Account',
            description: 'Tài khoản PUBG rank Conqueror, nhiều outfit hiếm'
        }
    ];
    
    const productsHTML = sampleProducts.map(product => `
        <div class="product-card" data-id="${product.id}">
            <div class="product-image">
                <img src="${product.image}" alt="${product.name}" loading="lazy">
                <div class="product-overlay">
                    <button class="btn btn-primary add-to-cart" onclick="showComingSoon('mua hàng')">
                        <i class="fas fa-shopping-cart"></i>
                        Thêm vào giỏ
                    </button>
                </div>
                <button class="favorite-btn" onclick="showComingSoon('yêu thích')">
                    <i class="far fa-heart"></i>
                </button>
            </div>
            <div class="product-info">
                <h3 class="product-name">${product.name}</h3>
                <p class="product-description">${product.description}</p>
                <div class="product-price">
                    <span class="current-price">${Utils.formatPrice(product.price)}đ</span>
                </div>
                <div class="product-rating">
                    <div class="stars">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <span class="rating-count">(${Math.floor(Math.random() * 50) + 10})</span>
                </div>
            </div>
        </div>
    `).join('');
    
    productsGrid.innerHTML = productsHTML;
}

// Back to top functionality
function initBackToTop() {
    const backToTopBtn = document.getElementById('backToTop');
    
    if (backToTopBtn) {
        const throttledScroll = Utils.throttle(() => {
            if (window.pageYOffset > 300) {
                backToTopBtn.classList.add('visible');
            } else {
                backToTopBtn.classList.remove('visible');
            }
        }, 100);
        
        window.addEventListener('scroll', throttledScroll);
        
        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }
}

// Global event listeners
function initGlobalEventListeners() {
    // Handle connection status
    window.addEventListener('online', () => {
        Utils.showToast('Kết nối internet đã được khôi phục', 'success');
    });
    
    window.addEventListener('offline', () => {
        Utils.showToast('Mất kết nối internet', 'warning');
    });
    
    // Handle page visibility change
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden && currentUser) {
            // Refresh data when page becomes visible
            updateCartCount();
        }
    });
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('Initializing Shop Grow A Garden...');
        
        // Initialize basic functionality
        initBackToTop();
        initGlobalEventListeners();
        
        // Check for auto-login FIRST
        await checkAutoLogin();
        
        // Initialize page-specific features
        initPageSpecificFeatures();
        
        // Initialize auth modal if login button exists
        const loginButton = document.getElementById('loginButton');
        if (loginButton) {
            initAuthModal();
        }
        
        console.log('Shop Grow A Garden initialized successfully');
        
    } catch (error) {
        console.error('Initialization failed:', error);
        Utils.showToast('Có lỗi xảy ra khi khởi tạo trang', 'error');
    }
});

// Handle page load completion
window.addEventListener('load', () => {
    Utils.hideLoading();
    
    // Initialize performance monitoring
    if (window.performance && window.performance.timing) {
        const loadTime = window.performance.timing.loadEventEnd - window.performance.timing.navigationStart;
        console.log(`Page loaded in ${loadTime}ms`);
    }
});

// Handle before page unload
window.addEventListener('beforeunload', () => {
    // Save any pending data
    if (currentUser) {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('userBalance', userBalance.toString());
    }
});

// Export functions for global use
window.Utils = Utils;
window.callApi = callApi;
window.authenticate = authenticate;
window.registerUser = registerUser;
window.logoutUser = logoutUser;
window.formatPrice = Utils.formatPrice;
window.showToast = Utils.showToast;

// Auth Modal Implementation - ENHANCED WITH BETTER EFFECTS
function initAuthModal() {
    const authModal = document.getElementById('authModal');
    const forgotModal = document.getElementById('forgotPasswordModal');
    const loginButton = document.getElementById('loginButton');
    
    if (!authModal || !loginButton) {
        console.warn('Auth modal elements not found');
        return;
    }
    
    const closeModal = document.getElementById('closeModal');
    const closeForgotModal = document.getElementById('closeForgotModal');
    const forgotPasswordLink = document.getElementById('forgotPassword');
    const modalTabs = document.querySelectorAll('.modal-tab');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    
    // Enhanced Modal Styles
    function addEnhancedModalStyles() {
        if (document.getElementById('enhanced-modal-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'enhanced-modal-styles';
        style.textContent = `
            .modal {
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                backdrop-filter: blur(8px);
            }
            
            .modal.show {
                animation: modalFadeIn 0.4s ease-out;
            }
            
            .modal-content {
                transform: scale(0.7) translateY(-50px);
                transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
                border-radius: 16px;
                overflow: hidden;
            }
            
            .modal.show .modal-content {
                transform: scale(1) translateY(0);
            }
            
            .modal-tab {
                position: relative;
                transition: all 0.3s ease;
                overflow: hidden;
            }
            
            .modal-tab::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.5s ease;
            }
            
            .modal-tab:hover::before {
                left: 100%;
            }
            
            .modal-tab.active {
                background: linear-gradient(135deg, #e63946, #f77f00);
                color: white;
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(230, 57, 70, 0.3);
            }
            
            .form-group {
                position: relative;
                margin-bottom: 20px;
            }
            
            .form-group input {
                transition: all 0.3s ease;
                border: 2px solid #e0e6ed;
                border-radius: 10px;
                padding: 12px 16px;
                background: rgba(255, 255, 255, 0.9);
            }
            
            .form-group input:focus {
                border-color: #e63946;
                box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.1);
                transform: translateY(-1px);
                background: white;
            }
            
            .form-group.has-error input {
                border-color: #dc3545;
                animation: shake 0.5s ease-in-out;
            }
            
            .btn-submit {
                position: relative;
                overflow: hidden;
                transition: all 0.3s ease;
                background: linear-gradient(135deg, #e63946, #f77f00);
                transform: perspective(1px) translateZ(0);
            }
            
            .btn-submit:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 25px rgba(230, 57, 70, 0.3);
            }
            
            .btn-submit.loading {
                pointer-events: none;
                opacity: 0.8;
            }
            
            .btn-submit .spinner {
                display: none;
                width: 20px;
                height: 20px;
                border: 2px solid rgba(255,255,255,0.3);
                border-top: 2px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-left: 10px;
            }
            
            .btn-submit.loading .spinner {
                display: inline-block;
            }
            
            .social-button {
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }
            
            .social-button::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                transform: translate(-50%, -50%);
                transition: width 0.6s ease, height 0.6s ease;
            }
            
            .social-button:hover::before {
                width: 300px;
                height: 300px;
            }
            
            .password-toggle {
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
                transition: all 0.2s ease;
                color: #6c757d;
            }
            
            .password-toggle:hover {
                background: rgba(230, 57, 70, 0.1);
                color: #e63946;
            }
            
            .error-message {
                color: #dc3545;
                font-size: 0.875rem;
                margin-top: 5px;
                display: none;
                animation: slideDown 0.3s ease;
            }
            
            @keyframes modalFadeIn {
                0% { opacity: 0; }
                100% { opacity: 1; }
            }
            
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            @keyframes slideDown {
                0% { opacity: 0; transform: translateY(-10px); }
                100% { opacity: 1; transform: translateY(0); }
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Password toggle functionality
    function initPasswordToggles() {
        document.querySelectorAll('.password-toggle').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                this.innerHTML = isPassword ? 
                    '<i class="fas fa-eye-slash"></i>' : 
                    '<i class="fas fa-eye"></i>';
                
                // Add animation
                this.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                }, 150);
            });
        });
    }
    
    // Form validation functions
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(String(email).toLowerCase());
    }
    
    function validatePassword(password) {
        return password.length >= 6;
    }
    
    function showError(input, message) {
        Utils.showError(input, message);
    }
    
    function clearError(input) {
        Utils.clearError(input);
    }
    
    // Enhanced form validation
    function initFormValidation() {
        const fields = [
            { id: 'loginEmail', validator: validateEmail, message: 'Email không hợp lệ' },
            { id: 'loginPassword', validator: validatePassword, message: 'Mật khẩu phải có ít nhất 6 ký tự' },
            { id: 'registerName', validator: (val) => val.length >= 2, message: 'Họ tên phải có ít nhất 2 ký tự' },
            { id: 'registerEmail', validator: validateEmail, message: 'Email không hợp lệ' },
            { id: 'registerPassword', validator: validatePassword, message: 'Mật khẩu phải có ít nhất 6 ký tự' },
            { id: 'forgotEmail', validator: validateEmail, message: 'Email không hợp lệ' }
        ];
        
        fields.forEach(field => {
            const element = document.getElementById(field.id);
            if (element) {
                // Real-time validation
                element.addEventListener('blur', function() {
                    if (!this.value) {
                        showError(this, `Vui lòng nhập ${Utils.getFieldName(this)}`);
                    } else if (!field.validator(this.value)) {
                        showError(this, field.message);
                    } else {
                        clearError(this);
                    }
                });
                
                element.addEventListener('input', function() {
                    if (this.value && field.validator(this.value)) {
                        clearError(this);
                    }
                });
            }
        });
        
        // Special validation for confirm password
        const confirmPassword = document.getElementById('registerConfirmPassword');
        if (confirmPassword) {
            confirmPassword.addEventListener('blur', function() {
                const password = document.getElementById('registerPassword').value;
                if (!this.value) {
                    showError(this, 'Vui lòng nhập lại mật khẩu');
                } else if (this.value !== password) {
                    showError(this, 'Mật khẩu không khớp');
                } else {
                    clearError(this);
                }
            });
        }
    }
    
    // Enhanced modal control functions
    function openModal(modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        setTimeout(() => modal.classList.add('show'), 10);
    }
    
    function closeModalFn(modal, form = null) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            if (form) {
                form.reset();
                form.querySelectorAll('.form-group.has-error').forEach(group => {
                    group.classList.remove('has-error');
                });
            }
        }, 400);
    }
    
    // Event listeners
    loginButton.addEventListener('click', () => {
        openModal(authModal);
        document.querySelector('.modal-tab[data-tab="login"]')?.click();
    });
    
    if (closeModal) {
        closeModal.addEventListener('click', () => {
            closeModalFn(authModal, loginForm);
        });
    }
    
    if (closeForgotModal && forgotModal) {
        closeForgotModal.addEventListener('click', () => {
            closeModalFn(forgotModal, forgotPasswordForm);
        });
    }
    
    // Close when clicking outside
    [authModal, forgotModal].forEach(modal => {
        if (modal) {
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModalFn(modal);
                }
            });
        }
    });
    
    // Enhanced tab switching
    modalTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active from all tabs
            modalTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            const tabName = this.getAttribute('data-tab');
            
            // Hide all forms
            document.querySelectorAll('.modal-form').forEach(form => {
                form.classList.remove('active');
                form.style.opacity = '0';
                form.style.transform = 'translateX(-20px)';
            });
            
            // Show target form with animation
            const targetForm = document.getElementById(`${tabName}Form`);
            if (targetForm) {
                setTimeout(() => {
                    targetForm.classList.add('active');
                    targetForm.style.opacity = '1';
                    targetForm.style.transform = 'translateX(0)';
                }, 150);
            }
        });
    });
    
    // Forgot password link
    if (forgotPasswordLink && forgotModal) {
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            closeModalFn(authModal);
            setTimeout(() => openModal(forgotModal), 400);
        });
    }
    
    // Switch to login from forgot password
    document.querySelectorAll('.switch-to-login').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            if (forgotModal) {
                closeModalFn(forgotModal);
                setTimeout(() => {
                    openModal(authModal);
                    document.querySelector('.modal-tab[data-tab="login"]')?.click();
                }, 400);
            }
        });
    });
    
    // Switch to register from login
    document.querySelectorAll('.switch-to-register').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector('.modal-tab[data-tab="register"]')?.click();
        });
    });
    
    // Enhanced form submissions
    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe')?.checked || false;
            const submitBtn = loginForm.querySelector('.btn-submit');
            
            // Validate form
            let isValid = true;
            
            if (!email || !validateEmail(email)) {
                showError(document.getElementById('loginEmail'), 'Email không hợp lệ');
                isValid = false;
            }
            
            if (!password || !validatePassword(password)) {
                showError(document.getElementById('loginPassword'), 'Mật khẩu phải có ít nhất 6 ký tự');
                isValid = false;
            }
            
            if (!isValid) return;
            
            // Show loading state
            if (submitBtn) {
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
            }
            
            try {
                const user = await authenticate(email, password);
                
                if (rememberMe) {
                    localStorage.setItem('rememberMe', 'true');
                } else {
                    localStorage.removeItem('rememberMe');
                }
                
                // Show success message
                Utils.showToast(`Chào mừng ${user.name} trở lại!`, 'success');
                
                // Close modal and update UI
                closeModalFn(authModal, loginForm);
                
                // Update UI after successful login
                await updateUIAfterLogin();
                
            } catch (error) {
                showError(document.getElementById('loginPassword'), error.message);
            } finally {
                if (submitBtn) {
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                }
            }
        });
    }
    
    if (registerForm) {
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const submitBtn = registerForm.querySelector('.btn-submit');
            
            // Validate form
            let isValid = true;
            
            if (!name || name.length < 2) {
                showError(document.getElementById('registerName'), 'Họ tên phải có ít nhất 2 ký tự');
                isValid = false;
            }
            
            if (!email || !validateEmail(email)) {
                showError(document.getElementById('registerEmail'), 'Email không hợp lệ');
                isValid = false;
            }
            
            if (!password || !validatePassword(password)) {
                showError(document.getElementById('registerPassword'), 'Mật khẩu phải có ít nhất 6 ký tự');
                isValid = false;
            }
            
            if (!confirmPassword || confirmPassword !== password) {
                showError(document.getElementById('registerConfirmPassword'), 'Mật khẩu không khớp');
                isValid = false;
            }
            
            if (!isValid) return;
            
            // Show loading state
            if (submitBtn) {
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
            }
            
            try {
                const user = await registerUser(name, email, password, confirmPassword);
                
                Utils.showToast(`Chào mừng ${user.name} đến với Shop Grow A Garden!`, 'success');
                
                // Close modal and update UI
                closeModalFn(authModal, registerForm);
                
                // Update UI after successful registration
                await updateUIAfterLogin();
                
            } catch (error) {
                showError(document.getElementById('registerEmail'), error.message);
            } finally {
                if (submitBtn) {
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                }
            }
        });
    }
    
    if (forgotPasswordForm) {
        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('forgotEmail').value.trim();
            const submitBtn = forgotPasswordForm.querySelector('.btn-submit');
            
            if (!email || !validateEmail(email)) {
                showError(document.getElementById('forgotEmail'), 'Email không hợp lệ');
                return;
            }
            
            if (submitBtn) {
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
            }
            
            // Simulate API call
            setTimeout(() => {
                if (submitBtn) {
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                }
                
                Utils.showToast('Yêu cầu đặt lại mật khẩu đã được gửi đến email của bạn!', 'success');
                
                setTimeout(() => {
                    closeModalFn(forgotModal, forgotPasswordForm);
                }, 1000);
            }, 2000);
        });
    }
    
    // Enhanced social login buttons
    document.querySelectorAll('.social-button').forEach(button => {
        button.addEventListener('click', function() {
            const provider = this.classList.contains('facebook') ? 'Facebook' : 'Google';
            const originalHTML = this.innerHTML;
            
            this.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite;"></div>';
            this.disabled = true;
            
            setTimeout(() => {
                Utils.showToast(`Đăng nhập bằng ${provider} sẽ có sớm!`, 'info');
                
                this.innerHTML = originalHTML;
                this.disabled = false;
            }, 2000);
        });
    });
    
    // Initialize components
    addEnhancedModalStyles();
    initPasswordToggles();
    initFormValidation();
}

// Make functions globally available
window.initAuthModal = initAuthModal;

// Coming soon functionality
function showComingSoon(feature) {
    Utils.showToast(`Tính năng ${feature} sẽ được cập nhật sớm!`, 'info');
}

window.showComingSoon = showComingSoon;

// Performance monitoring
if (window.performance && window.performance.mark) {
    window.performance.mark('main-js-loaded');
}

console.log('Main.js loaded successfully - Shop Grow A Garden v2.0 Enhanced');
