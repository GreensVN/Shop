<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - Shop Grow A Garden</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- SỬA LỖI: Đồng bộ cấu trúc header với index.html -->
    <header class="header" id="header">
        <div class="container header-container">
            <a href="index.html">
                <img src="https://i.ibb.co/q3r1hTft/8574d186247eba75669b7d50d42bd650-png.png" alt="Shop Grow A Garden" class="logo">
            </a>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i><span>Trang Chủ</span></a>
                <a href="#" class="nav-link"><i class="fas fa-seedling"></i><span>Giống Cây</span></a>
                <a href="#" class="nav-link"><i class="fas fa-paw"></i><span>Thú Cưng</span></a>
                <a href="#" class="nav-link"><i class="fas fa-gamepad"></i><span>Tài Khoản Game</span></a>
            </nav>
            <!-- Vùng chứa cho trạng thái người dùng, sẽ được JS cập nhật -->
            <div id="user-section-placeholder">
                 <button class="btn btn-primary" id="loginButton">
                    <i class="fas fa-user"></i>
                    <span>Đăng Nhập</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title"><i class="fas fa-shopping-cart"></i> Giỏ Hàng Của Bạn</h1>
        <div class="cart-container" id="cartContainer">
             <!-- Nâng cấp: Nội dung giỏ hàng sẽ được JS render ở đây -->
        </div>
    </main>

    <footer class="footer">
        <!-- Nội dung footer giữ nguyên như index.html -->
    </footer>
    
    <div class="modal" id="authModal" style="display:none;">
        <!-- ... Toàn bộ nội dung của #authModal từ index.html nên được đặt ở đây ... -->
    </div>

    <script src="main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initAuthModal();
            if (localStorage.getItem('token')) {
                updateUIAfterLogin().then(loadCart);
            } else {
                 // NÂNG CẤP: Xử lý khi người dùng chưa đăng nhập
                 displayLoginPromptForCart();
            }
        });

        // NÂNG CẤP: Các hàm hiển thị trạng thái khác nhau của giỏ hàng
        function displayLoginPromptForCart() {
            const cartContainer = document.getElementById('cartContainer');
            cartContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-sign-in-alt empty-state-icon"></i>
                    <h3 class="empty-state-title">Vui lòng đăng nhập</h3>
                    <p class="empty-state-text">Bạn cần đăng nhập để xem giỏ hàng và tiến hành thanh toán.</p>
                    <button class="btn btn-primary" id="loginRedirectButton">Đăng nhập ngay</button>
                </div>`;
            document.getElementById('loginRedirectButton').addEventListener('click', () => {
                const authModal = document.getElementById('authModal');
                authModal.style.display = 'flex';
                setTimeout(() => authModal.classList.add('show'), 10);
            });
        }

        function showEmptyCartMessage() {
             const cartContainer = document.getElementById('cartContainer');
             cartContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shopping-bag empty-state-icon"></i>
                    <h3 class="empty-state-title">Giỏ hàng của bạn đang trống</h3>
                    <p class="empty-state-text">Hãy lựa chọn những sản phẩm tuyệt vời và thêm vào giỏ hàng nhé.</p>
                    <a href="index.html" class="btn btn-primary">Tiếp tục mua sắm</a>
                </div>`;
        }

        async function loadCart() {
            const cartContainer = document.getElementById('cartContainer');
            cartContainer.innerHTML = '<div class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Đang tải giỏ hàng...</div>';

            try {
                const cartItems = await getCart();
                if (!cartItems || cartItems.length === 0) {
                    showEmptyCartMessage();
                    return;
                }

                cartContainer.innerHTML = `
                    <div class="cart-items-list" id="cartItemsList"></div>
                    <div class="cart-summary" id="cartSummary"></div>`;
                
                const cartItemsList = document.getElementById('cartItemsList');
                cartItems.forEach(item => {
                    if (!item.product) return;
                    cartItemsList.appendChild(createCartItemElement(item));
                });
                
                updateCartSummary();
                attachCartEventListeners();
            } catch (error) {
                cartContainer.innerHTML = `<div class="error-state">Không thể tải giỏ hàng. Vui lòng thử lại sau.</div>`;
            }
        }

        function createCartItemElement(item) {
            const element = document.createElement('div');
            element.className = 'cart-item fade-in';
            element.setAttribute('data-product-id', item.product._id);
            element.innerHTML = `
                <img src="${item.product.images && item.product.images.length > 0 ? item.product.images[0] : 'placeholder.jpg'}" alt="${item.product.title}" class="cart-item-image">
                <div class="cart-item-details">
                    <h3 class="cart-item-title">${item.product.title}</h3>
                    <div class="cart-item-price" data-price="${item.product.price}">${formatPrice(item.product.price)}đ</div>
                </div>
                <div class="cart-item-quantity">
                    <button class="btn-quantity" data-id="${item.product._id}" data-action="minus">-</button>
                    <input type="number" value="${item.quantity}" min="1" class="quantity-input" data-id="${item.product._id}">
                    <button class="btn-quantity" data-id="${item.product._id}" data-action="plus">+</button>
                </div>
                <div class="cart-item-total" id="total-${item.product._id}">${formatPrice(item.product.price * item.quantity)}đ</div>
                <button class="btn-remove-item" data-id="${item.product._id}"><i class="fas fa-trash"></i></button>`;
            return element;
        }

        function updateCartSummary() {
            const allItems = document.querySelectorAll('.cart-item');
            if (allItems.length === 0) {
                 showEmptyCartMessage();
                 return;
            }

            let subtotal = 0;
            allItems.forEach(item => {
                const price = parseFloat(item.querySelector('.cart-item-price').dataset.price);
                const quantity = parseInt(item.querySelector('.quantity-input').value);
                subtotal += price * quantity;
            });
            
            const shipping = 0; // Có thể thêm logic tính phí ship sau
            const total = subtotal + shipping;
            
            const cartSummary = document.getElementById('cartSummary');
            cartSummary.innerHTML = `
                <h3>Tổng Cộng</h3>
                <div class="summary-row"><span>Tạm tính</span><span>${formatPrice(subtotal)}đ</span></div>
                <div class="summary-row"><span>Phí vận chuyển</span><span>${formatPrice(shipping)}đ</span></div>
                <div class="summary-divider"></div>
                <div class="summary-row total"><span>Thành tiền</span><span>${formatPrice(total)}đ</span></div>
                <button class="btn btn-primary btn-block" id="checkoutButton">Tiến Hành Thanh Toán</button>`;
            
            document.getElementById('checkoutButton').addEventListener('click', () => showToast('Chức năng đang được phát triển!', 'info'));
        }

        function attachCartEventListeners() {
            const cartItemsList = document.getElementById('cartItemsList');
            if (!cartItemsList) return;

            cartItemsList.addEventListener('click', e => {
                const target = e.target;
                if (target.closest('.btn-quantity')) {
                    handleQuantityChange(target.closest('.btn-quantity'));
                } else if (target.closest('.btn-remove-item')) {
                    handleRemoveItem(target.closest('.btn-remove-item'));
                }
            });
            
            cartItemsList.addEventListener('change', e => {
                 if(e.target.classList.contains('quantity-input')) {
                     handleQuantityInputChange(e.target);
                 }
            });
        }
        
        function handleQuantityChange(button) {
            const productId = button.dataset.id;
            const action = button.dataset.action;
            const input = document.querySelector(`.quantity-input[data-id="${productId}"]`);
            let quantity = parseInt(input.value);

            if(action === 'plus') quantity++;
            else if(action === 'minus' && quantity > 1) quantity--;
            
            input.value = quantity;
            updateItemQuantity(productId, quantity);
        }

        function handleQuantityInputChange(input) {
            const productId = input.dataset.id;
            let quantity = parseInt(input.value);
            if (isNaN(quantity) || quantity < 1) {
                quantity = 1;
                input.value = 1;
            }
            updateItemQuantity(productId, quantity);
        }

        async function handleRemoveItem(button) {
            const productId = button.dataset.id;
            const success = await removeFromCart(productId);
            if(success) {
                const itemToRemove = button.closest('.cart-item');
                itemToRemove.classList.add('fade-out');
                setTimeout(() => {
                    itemToRemove.remove();
                    updateCartSummary();
                    updateCartCount();
                }, 500);
            }
        }
        
        async function updateItemQuantity(productId, quantity) {
            const success = await updateCartItemQuantity(productId, quantity);
            if(success) {
                const itemRow = document.querySelector(`.cart-item[data-product-id="${productId}"]`);
                if(itemRow) {
                    const price = parseFloat(itemRow.querySelector('.cart-item-price').dataset.price);
                    document.getElementById(`total-${productId}`).textContent = `${formatPrice(price * quantity)}đ`;
                }
                updateCartSummary();
                updateCartCount();
            }
        }
    </script>
</body>
</html>
